/***
 *  BetterFramework is BetterStudio framework for themes and plugins.
 *
 *  ______      _   _             ______                                           _
 *  | ___ \    | | | |            |  ___|                                         | |
 *  | |_/ / ___| |_| |_ ___ _ __  | |_ _ __ __ _ _ __ ___   _____      _____  _ __| | __
 *  | ___ \/ _ \ __| __/ _ \ '__| |  _| '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /
 *  | |_/ /  __/ |_| ||  __/ |    | | | | | (_| | | | | | |  __/\ V  V / (_) | |  |   <
 *  \____/ \___|\__|\__\___|_|    \_| |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\
 *
 *  Copyright Â© 2017 Better Studio
 *
 *
 *  Our portfolio is here: https://betterstudio.com/
 *
 *  \--> BetterStudio, 2017 <--/
 */
!function(m){"use strict";var s=function(t,e){if(this.options=m.extend(!0,{itemBeforeHtml:'<li class="bssm-item {{class}}"{{#type}} data-item-type="{{type}}"{{/type}}{{#cat}} data-item-cat="{{cat}}"{{/cat}} data-item-id="{{id}}">',itemInnerHtml:"",itemAfterHtml:"</li>",modalHtml:!1,id:"modal-"+Math.ceil(1e3*Math.random()),bsModal:e||{},content:{},items:{},itemsGroupSize:6,fuse:{keys:["name"],tokenize:!0,matchAllTokens:!0,threshold:.3},searchDelay:300,overlayClickCloseModal:!0,searchAutoFocus:!0,selectedItemId:0,modalClass:"",categories:{},types:{},inactivateTypes:[],inactivateCats:[],noSidebar:!1,events:{show_item:function(t){t.style.display="inline-block"},hide_item:function(t){t.style.display="none"}}},t),!this.options.modalHtml){var s="";this._length(this.options.categories)&&(s='<div class="bssm-categories">\n    <h4 class="title"><span>{{filter_cat_title}}</span></h4>\n\n    <ul class="bssm-filter-items bf-radio-group">\n\n        {{#count_all}}\n        <li>\n            <div class="bf-radio-field" data-current-state="active" data-name="all"><span style="display: inline-block;"><i class="fa fa-circle" aria-hidden="true"></i></span></div>\n            <span class="name bf-radio-toggle" data-id="{{key}}">{{all_l10n}}</span><span class="length">({{count_all}})</span>\n        </li>\n        {{/count_all}}\n        \n        {{#filter_cats}}\n        <li>\n            <div class="bf-radio-field" data-current-state="deactivate" data-name="{{key}}"><span><i class="fa fa-circle" aria-hidden="true"></i></span></div>\n            <span class="name bf-radio-toggle" data-id="{{key}}">{{value}}</span><span class="length">({{count}})</span>\n        </li>\n        {{/filter_cats}}\n\n    </ul>\n</div>\n');var i="";this._length(this.options.types)&&(i='\n<div class="bssm-types">\n    <h4 class="title"><span>{{filter_type_title}}</span></h4>\n\n    <ul class="bssm-filter-items bf-radio-group">\n\n        {{#count_all}}\n        <li>\n            <div class="bf-radio-field" data-current-state="active" data-name="all"><span style="display: inline-block;"><i class="fa fa-circle" aria-hidden="true"></i></span></div>\n            <span class="name bf-radio-toggle" data-id="{{key}}">{{all_l10n}}</span><span class="length">({{count_all}})</span>\n        </li>\n        {{/count_all}}\n\n        {{#filter_types}}\n        <li>\n            <div class="bf-radio-field" data-current-state="deactivate" data-name="{{key}}"><span><i class="fa fa-circle" aria-hidden="true"></i></span></div>\n            <span class="name bf-radio-toggle" data-id="{{key}}">{{value}}</span>{{#count}}<span class="length">({{count}})</span>{{/count}}\n        </li>\n        {{/filter_types}}\n    </ul>\n</div>\t'),this.options.modalHtml='<div class="bs-modal-default bs-selector-modal '+this.options.modalClass+'" {{#inline_style}} style="{{inline_style}}" {{/inline_style}}>\n{{#close_button}}\n<a href="#" class="bs-close-modal">\n    <i class="fa fa-times" aria-hidden="true"></i>\n</a>\n{{/close_button}}\n<div class="bs-modal-header-wrapper bs-modal-clearfix">\n    <h2 class="bs-modal-header">\n        {{#icon}}\n        <i class="fa {{icon}}"></i>\n        {{/icon}}\n\n        {{{header}}}\n    </h2>\n</div>\n\n<div class="bs-modal-body">\n    \x3c!--{{{bs_body}}}--\x3e\n\n    <input type="hidden" name="item" class="bssm-input">\n\n    <div class="bssm-content {{content_class}}">\n        <ul class="bssm-list">\n            {{#items}}\n                '+this.options.itemBeforeHtml+this.options.itemInnerHtml+this.options.itemAfterHtml+'        \n            {{/items}}\n        </ul>\n    </div>\n    <div class="bssm-sidebar">\n        <div class="bssm-search">\n            <input type="text" class="bssm-search-input" value="" placeholder="{{search}}" autofocus>\n            <i class="fa fa-search"></i>\n        </div>\n\n        <div class="bssm-filter">\n            \n            '+s+i+"              </div>\n\n     \n    </div>\n</div>"}this.bsModal=!1,this.$allItems=!1,this.$itemsCache={},this._scrollIntoView=[],this._visibleItems=[],this.selectedItem=!1,this.initialized=!1,this.fuse=new Fuse(this.options.items,this.options.fuse),this.init()};s.prototype={init:function(){var t=this;t.initialized=!0,m.bs_modal_template(this.options.id,this.options.modalHtml);var e={modalId:this.options.id,buttons:this.options.buttons,destroyHtml:!1,modalClass:this.options.modalClass,show:!1,styles:{container:"width: 1060px;max-width:100%"},template:this.options.id,content:t._getModalContent(),events:{before_append_html:function(){},after_append_html:function(){t.bsModal=this,t.options.noSidebar&&t.bsModal.$modal.addClass("no-sidebar"),t.updateItemsList(),t._bindEvents(),t._clearSearchResults(),t._updateSidebarCheckboxStatus(),t.handleEvent("after_append_html","")},modal_closed:function(){t._clearSearchResults(),t._updateSidebarCheckboxStatus("dont-refresh-items"),t._showHide(t.$allItems,!0),t.handleEvent("modal_closed",""),t.initialized=!1},modal_loaded:function(){t.options.searchAutoFocus&&m("input.bssm-search-input",this.$modal).focus(),t.handleEvent("modal_loaded","")},modal_show:function(){t.handleEvent("modal_show",""),t.initialized&&t.scrollIntoView(0,t.options.itemsGroupSize)}}};m.bs_modal(m.extend(!0,e,t.options.bsModal))},show:function(){this.bsModal.show()},updateItemsList:function(){this.$allItems=m(".bssm-item",this.bsModal.$modal)},_bindEvents:function(){var c=this,n=this.bsModal.$modal;function o(t){c._visibleItems=t}o(c.$allItems);var l,r=m(".bssm-list",n),d=r.find(".bssm-item");function t(){var t=d.outerHeight(!0);var e,s,i,a=(i=c.options.itemsGroupSize/(e=r.width(),s=r.find(".bssm-item").outerWidth(!0),Math.max(1,Math.floor(e/s))),Math.ceil(r.scrollTop()/(t*i)));if(a){var n=a*c.options.itemsGroupSize;c.scrollIntoView(n,n+c.options.itemsGroupSize)}}function s(t,e){if(-1===m.inArray(t.which,[32,27])){clearTimeout(l);var i=m.trim(this.value),s=m(this).parent(),a=s.find("i.fa");s[i?"addClass":"removeClass"]("active"),i?a.addClass("fa-times-circle").removeClass("fa-search"):a.removeClass("fa-times-circle").addClass("fa-search"),"change-icon"!==e&&(l=setTimeout(function(){if(m(".bssm-filter-items .bf-radio-field[data-name='all']",n).trigger("click",["search"]),i){var e=[];c.fuse.search(i).forEach(function(t){e.push(t.id)});for(var t=[],s=0;s<c.$allItems.length;s++)-1!==e.indexOf(c.get_attr(c.$allItems[s],"itemId"))&&t.push(c.$allItems[s]);c._showHide(c.$allItems,!1),c._showHide(t,!0),o(t)}else c.$allItems.show(),o(c.$allItems)},c.options.searchDelay))}}c._cacheItems(d),c.eventExists("item_click")&&r.on("click",".bssm-item",function(){c.handleEvent("item_click",this)}),r.on("click",".bssm-item",function(){var t=c.$(this);c.markAsSelected(t),c.handleEvent("item_select",this,t.data("item-id"))}),m(".bssm-search",n).each(function(){var e=m(this);m(".bssm-search-input",e).on("keyup",s),e.on("click",".fa-times-circle",function(){var t=m(".bssm-search-input",e);t.val(""),t.trigger("keyup")})}),m(".bssm-sidebar .bf-radio-group",n).on("bf-radio-change",function(t,e,s){if("dont-refresh-items"!==s){"search"!==s&&m(".bssm-search-input",n).val("").trigger("keyup",["change-icon"]);var i=function(){function t(t){var e=[],s=m(".bssm-"+t+" .bf-radio-field[data-current-state='active']",n).data("name");if(s)if("all"===s){var i="categories"===t?"filter_cats":"filter_"+t;c.bsModal.options.content[i]&&c.bsModal.options.content[i].forEach(function(t){e.push(t.key)})}else e.push(s);return e}var l={};return c._length(c.options.types)&&(l.itemType=t("types")),c._length(c.options.categories)&&(l.itemCat=t("categories")),c._filterItems(function(){return function(t){var e,s,i=c.$(t).data();for(var a in l)if(e=l[a],void 0!==i[a]&&""!==i[a]){"string"==typeof(s=c.json_decode(i[a]))&&(s=[s]),"string"==typeof e&&(e=[e]);for(var n=!1,o=0;o<s.length;o++)if(-1<m.inArray(s[o],e)){n=!0;break}if(!n)return!1}return!0}(this)})}();c._showHide(c.$allItems,!1),c._showHide(i,!0),o(i)}}),c.eventExists("scrollIntoView")&&r.on("scroll",function(){t()}),c.options.overlayClickCloseModal&&c.bsModal.find(".bs-modal-overlay").on("click",function(){c.bsModal.close_modal()})},scrollIntoView:function(t,e){for(var s,i=this,a=i._visibleItems.slice(t,e),n=[],o=0;o<a.length;o++)s=i.get_attr(a[o],"itemId"),-1===i._scrollIntoView.indexOf(s)&&(i._scrollIntoView.push(s),n.push(a[o]));n.length&&i.handleEvent("scrollIntoView",n,t,e)},getSelectedItem:function(){return this.selectedItem},setSelectedItem:function(t,e){this.selectedItem=[t,e]},markAsSelected:function(t){this.$allItems.removeClass("bssm-selected"),t.addClass("bssm-selected"),this.setSelectedItem(t,t.data("item-id"))},json_encode:function(t){return(t=JSON.stringify(t)).replace(/"/g,'\\"').replace(/'/g,"\\'")},json_decode:function(t){return t=t.replace(/\\"/g,'"').replace(/\\'/g,"'"),JSON.parse(t)},_getModalContent:function(){var t,a=this,s=a.options.content,e=a.options;s.items=[],a.options.items.forEach(function(t){var e=m.extend({},t);e.cat&&(e.cat=a.json_encode(t.cat)),e.type&&(e.type=a.json_encode(t.type)),s.items.push(e)});for(var n=a._length(a.options.items),i=0,o=0;o<n;o++)"object"==typeof a.options.items[o]&&"default"!==a.options.items[o].id&&i++;function l(t,e){for(var s,i=0;i<t.length;i++)void 0!==e[s=t[i].key]?t[i].count=String(e[s]):t[i].count="0";return t}function c(t){for(var e,s={},i=0;i<n;i++)"object"==typeof a.options.items[i]&&(s[e=a.options.items[i][t]]?s[e]++:s[e]=1);return s}return t=a._prepareObjectForMustache(e.categories),s.filter_cats=l(t,c("cat")),t=a._prepareObjectForMustache(e.types),s.filter_types=l(t,c("type")),s.count_all=i,this.handleEvent("modal_content",s)},_updateSidebarCheckboxStatus:function(i){var a=this;m(".bssm-sidebar .name[data-id]",a.bsModal.$modal).each(function(){var t=m(this),e=t.parent().find(".bf-checkbox-multi-state"),s=e.data("current-state");-1<m.inArray(t.data("id"),a.options.inactivateTypes)?"none"!==s&&e.trigger("click",[i]):"active"!==s&&e.trigger("click",[i])})},_clearSearchResults:function(){return},_filterItems:function(t){return this.$allItems.filter(t)},handleEvent:function(t,e){var s=Array.prototype.slice.call(arguments,1);return"function"==typeof this.options.events[t]?this.options.events[t].apply(this,s):e},eventExists:function(t){return"function"==typeof this.options.events[t]},$:function(t){return t.dataset.itemId?(t.dataset.itemId in this.$itemsCache||(this.$itemsCache[t.dataset.itemId]=m(t,this.$modal)),this.$itemsCache[t.dataset.itemId]):m(t,this.$modal)},selectItem:function(t){return t in this.$itemsCache||(this.$itemsCache[t]=m('.bssm-item[data-item-id="'+t+'"]',this.bsModal.$modal)),this.$itemsCache[t]},_showHide:function(t,e){for(var s=e?"show_item":"hide_item",i=0;i<t.length;i++)t[i]&&this.handleEvent(s,t[i])},get_attr:function(t,e){return t.dataset?t.dataset[e]:this.$(t,this.bsModal.$modal).attr(e)},_prepareObjectForMustache:function(t){var e=[];for(var s in t)e.push({key:s,value:t[s]});return e},_cacheItems:function(t){var e,s;this.$itemsCache={};for(var i=0;i<t.length;i++)s=(e=m(t[i])).data("item-id"),this.$itemsCache[s]=e},_length:function(t){if(!t)return 0;if(Object.keys)return Object.keys(t).length;var e,s=0;for(e in t)t.hasOwnProperty(e)&&s++;return s}},m.bs_selector_modal=function(t,e){return new s(t,e)}}(jQuery);