/***
 *  BetterStudio Themes Core.
 *
 *  ______  _____   _____ _                           _____
 *  | ___ \/  ___| |_   _| |                         /  __ \
 *  | |_/ /\ `--.    | | | |__   ___ _ __ ___   ___  | /  \/ ___  _ __ ___
 *  | ___ \ `--. \   | | | '_ \ / _ \ '_ ` _ \ / _ \ | |    / _ \| '__/ _ \
 *  | |_/ //\__/ /   | | | | | |  __/ | | | | |  __/ | \__/\ (_) | | |  __/
 *  \____/ \____/    \_/ |_| |_|\___|_| |_| |_|\___|  \____/\___/|_|  \___|
 *
 *  Copyright Â© 2017 Better Studio
 *
 *
 *  Our portfolio is here: http://themeforest.net/user/Better-Studio/portfolio
 *
 *  \--> BetterStudio, 2017 <--/
 */
var BetterStudio_TinyMCE_View={settings:{},fetchShortcodes:[],shortcodeCounter:0,fetchAllQueue:0,repeaterPrefix:"bf-metabox-option",init:function(t){var e=this;BF_TinyMCE_View.shortcodes&&BF_TinyMCE_View.shortcodes.forEach(function(t){e.registerView(t)}),this.$=t},initEditModal:function(t){function e(){s.children(".group").hide()}function o(t){t.find(":input:first").trigger("force-change")}var n=this,s=n.$(".tinymce-addon-fields",t);s.length&&(e(),s.children(".group:first").show(),n.$(".tabs-wrapper li:first").addClass("active-tab"),n.$(".bf-tab-item-a",s).on("click",function(){var t=n.$(this).closest("li"),i=t.data("go"),r="bf-tmv-"+i;t.addClass("active-tab"),t.siblings("li").removeClass("active-tab");var c=n.$("#"+r,s);e(),c.fadeIn(500),o(c)}))},setSettings:function(t){t&&t.shortcode&&(this.settings[t.shortcode]=t.settings)},getSettings:function(t){return this.settings[t]},registerView:function(t){var e=this;t=_.extend({},{extend:{}},t),t.settings&&e.setSettings(t),wp.mce.views.register(t.shortcode,_.extend({},e.viewsBaseClass(t),t.extend))},doShortcode:function(t,e){var o=this;clearTimeout(o.fetchAllQueue),o.fetchAllQueue=setTimeout(function(){o.fetchAllShortcodes.call(o)}),o.fetchShortcodes.push({query:{shortcode:t,id:o.shortcodeCounter},id:o.shortcodeCounter,view:e}),o.shortcodeCounter++},fetchAllShortcodes:function(){var t,e=this,o=_.pluck(e.fetchShortcodes,"query"),n=parseInt(BF_TinyMCE_View.doshortcode_steps||5),s=_.groupBy(o,function(t,e){return Math.floor(e/n)}),i=Better_Framework._length(s),r=0;for(var c in s)t=s[c],wp.ajax.post("bf_ajax",{reqID:"fetch-mce-view-shortcode",nonce:better_framework_loc.nonce,shortcodes:t,post_id:wp.media.view.settings.post.id}).done(function(t){_.each(t,function(t,o){var n=_.findWhere(e.fetchShortcodes,{id:parseInt(o)});n&&n.view&&("no-items"===t.type?n.view.setError("["+n.view.shortcode.tag+"]<br/>"+t.message,"no-alt"):n.view.render(t))})}).always(function(){++r===i&&(e.fetchShortcodes=[],e.shortcodeCounter=0)})},viewsBaseClass:function(){var t=this;return wp.mce.bsShortcodes?wp.mce.bsShortcodes:(wp.mce.bsShortcodes={args:{},initialize:function(){var e=this;t.doShortcode(e.shortcode.string(),e)},shortcode_data:{},edit:function(e,o){var n=this,s=wp.shortcode.next(n.shortcode.tag,e),i=s.shortcode.attrs.named;i.innercontent=s.shortcode.content;var r={custom_event:{label:BS_Shortcode_loc.save,type:"primary",clicked:function(){var e=this,s={};t.$(".bs-modal-body",this.$modal).clone();t.$(".mce-field",this.$modal).each(function(){if("radio"!==this.type||this.checked){var t=this.name.match(/\[(.*?)\]/g);if(t){var e,o=this.name.match(/^(.*?)(?=\[)/)[1];"undefined"==typeof s[o]&&(s[o]={}),e=s[o];for(var n=0;n<t.length;n++)o=t[n].substr(0,t[n].length-1).substr(1),"undefined"==typeof e[o]&&(e[o]={}),e=e[o];e.__VALUE__=this.value}else s[this.name]=this.value}}).promise().done(function(){var i=t.getSettings(n.shortcode.tag),r="";if(i.sub_shortcodes){var c,a,d;for(c in i.sub_shortcodes)s[c]&&(a=i.sub_shortcodes[c],_.each(s[c],function(t){t=_.mapObject(t,function(t){return"object"==typeof t&&"__VALUE__"in t?t.__VALUE__:t}),d="string"==typeof i.extra.shortcode_content_fields[c]?i.extra.shortcode_content_fields[c]:"";var e="";d&&"undefined"!=typeof t[d]&&(e=t[d],delete t[d]),r+="\n	",r+=wp.shortcode.string({tag:a,content:e,attrs:t,type:"close"})}),delete s[c])}r&&(r+="\n"),o(wp.shortcode.string({tag:n.shortcode.tag,attrs:_.pick(s,_.identity),type:"open",content:r}),!1),e.close_modal("tinymce")})}},close_modal:{type:"secondary",action:"close",label:better_framework_loc.translation.reset_panel.button_no,focus:!0}},c=t.$.bs_modal({modalId:"es-modal",skin:"loading",content:{header:"Loading...",title:"Loading...",body:""},buttons:r,events:{before_append_html:function(){var t=155e3;this.$overlay.css("z-index",t),this.$modal.css("z-index",t+1)},after_append_html:function(){t.initEditModal(this.$modal)}}});wp.ajax.post("bf_ajax",{action:"bf_ajax",reqID:"fetch-mce-view-fields",nonce:better_framework_loc.nonce,shortcode:n.shortcode.tag,shortcode_content:s.shortcode.content,shortcode_values:i}).done(function(e){c.change_skin({skin:"skin-1",animations:{},content:{header:function(o){var s=t.getSettings(n.shortcode.tag),i=s.name||"";return e.settings&&(s.extra=e.settings,t.setSettings({settings:s,shortcode:n.shortcode.tag})),o.toString().replace("%shortcode%",i)}(BF_TinyMCE_View.l10n.modal.header),title:"",body:e.output},buttons:r})})}},wp.mce.bsShortcodes)}};jQuery(function(){BetterStudio_TinyMCE_View.init(jQuery)});